@model IEnumerable<SIGHR.Models.ViewModels.HorarioAdminViewModel>
@using System.Globalization

@{
    ViewData["Title"] = "Registo de Entradas - Administração";
    Layout = "_LayoutAdmin";
}

@section Styles {
    <style>
        /* ... (os teus estilos CSS existentes) ... */
        .action-buttons .btn,
        .action-buttons .download-btn {
            padding: 8px 15px;
            margin-left: 10px;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            border: 1px solid transparent;
            color: black;
        }

        .search-bar {
            margin-bottom: 20px;
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap; /* Permite que os filtros passem para a linha de baixo se não houver espaço */
            gap: 10px;
            align-items: center;
        }

        /* ================== NOVO ESTILO ================== */
        /* Adiciona um 'label' visual para os filtros de data */
        .date-filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: nowrap; /* Impede que o label e o input se partam */
        }
        /* ================== FIM DO NOVO ESTILO ================== */


        .search-bar input[type="text"],
        .search-bar input[type="date"],
        .search-bar .form-control {
            padding: .375rem .75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #ced4da;
            border-radius: .25rem;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
            flex-grow: 1;
            min-width: 180px;
        }

            .search-bar input[type="text"]:focus,
            .search-bar input[type="date"]:focus {
                border-color: #86b7fe;
                outline: 0;
                box-shadow: 0 0 0 .2rem rgba(13,110,253,.25);
            }


        .search-bar .filter-btn {
            padding: .375rem .75rem;
            font-size: 1rem;
            border-radius: .25rem;
            color: #fff;
            border: 1px solid transparent;
            cursor: pointer;
            line-height: 1.5;
        }

        .filter-btn.clear {
            background-color: #6c757d;
            color: #fff;
            text-decoration: none;
        }

        .table thead th {
            color: black;
            border-bottom-width: 2px;
        }

        .table tbody td {
            vertical-align: middle;
        }

        .table-actions-cell a {
            margin-right: 5px;
        }
    </style>
}

<div class="content">
    <div class="header">
        <h2>@ViewData["Title"]</h2>
        <div class="action-buttons">
            <button type="button" onclick="downloadHorariosExcelComFiltros()" class="btn download-btn">Transferir Excel</button>
        </div>
    </div>

    <form method="get" asp-action="Index" asp-controller="Admin" class="search-bar" id="formFiltrosHorarios">

        <input type="text" name="filtroNome" id="inputFiltroNomeAdmin" value="@ViewData["FiltroNomeAtual"]" placeholder="Pesquisar por nome do utilizador" class="form-control" />

        <div class="date-filter-group">
            <label for="inputFiltroDataInicio" class="form-label" style="margin-bottom:0; white-space:nowrap;">De:</label>
            <input type="date" name="filtroDataInicio" id="inputFiltroDataInicio" value="@ViewData["FiltroDataInicioAtual"]" class="form-control" />
        </div>

        <div class="date-filter-group">
            <label for="inputFiltroDataFim" class="form-label" style="margin-bottom:0; white-space:nowrap;">Até:</label>
            <input type="date" name="filtroDataFim" id="inputFiltroDataFim" value="@ViewData["FiltroDataFimAtual"]" class="form-control" />
        </div>

        <button type="submit" class="btn filter-btn apply">Filtrar</button>
        <a asp-action="Index" asp-controller="Admin" class="btn filter-btn clear">Limpar</a>
    </form>
    @if (Model == null || !Model.Any())
    {
        <p class="no-records">Nenhum registo de ponto encontrado para os filtros aplicados.</p>
    }
    else
    {
        <div class="table-responsive table-container">
            <table id="tabela-horarios-admin" class="table table-striped table-hover table-bordered admin-table">
                <thead>
                    <tr>
                        <th>Utilizador</th>
                        <th>Data</th>
                        <th>Hora Entrada</th>
                        <th>Saída Almoço</th>
                        <th>Entrada Almoço</th>
                        <th>Saída</th>
                        <th>Total de Horas</th>
                        <th>Loc. Entrada</th>
                        <th>Loc. S. Almoço</th>
                        <th>Loc. E. Almoço</th>
                        <th>Loc. Saída</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@Html.DisplayFor(modelItem => item.NomeUtilizador)</td>
                            <td>@item.Data.ToLocalTime().ToString("dd/MM/yyyy")</td>
                            <td class="utc-time" data-utc-time="@item.HoraEntrada.ToString("o")">--:--</td>
                            <td class="utc-time" data-utc-time="@item.SaidaAlmoco.ToString("o")">--:--</td>
                            <td class="utc-time" data-utc-time="@item.EntradaAlmoco.ToString("o")">--:--</td>
                            <td class="utc-time" data-utc-time="@item.HoraSaida.ToString("o")">--:--</td>
                            <td>@Html.DisplayFor(modelItem => item.TotalHorasTrabalhadas)</td>

                            <td>
                                @if (item.LatitudeEntrada.HasValue && item.LatitudeEntrada != 0)
                                {
                                    <a href="https://www.google.com/maps?q=@item.LatitudeEntrada!.Value.ToString("G", CultureInfo.InvariantCulture),@item.LongitudeEntrada!.Value.ToString("G", CultureInfo.InvariantCulture)" target="_blank">Ver Mapa</a>
                                }
                                else
                                {
                                    <text>N/D</text>
                                }
                            </td>
                            <td>
                                @if (item.LatitudeSaidaAlmoco.HasValue && item.LatitudeSaidaAlmoco != 0)
                                {
                                    <a href="https://www.google.com/maps?q=@item.LatitudeSaidaAlmoco!.Value.ToString("G", CultureInfo.InvariantCulture),@item.LongitudeSaidaAlmoco!.Value.ToString("G", CultureInfo.InvariantCulture)" target="_blank">Ver Mapa</a>
                                }
                                else
                                {
                                    <text>N/D</text>
                                }
                            </td>
                            <td>
                                @if (item.LatitudeEntradaAlmoco.HasValue && item.LatitudeEntradaAlmoco != 0)
                                {
                                    <a href="https://www.google.com/maps?q=@item.LatitudeEntradaAlmoco!.Value.ToString("G", CultureInfo.InvariantCulture),@item.LongitudeEntradaAlmoco!.Value.ToString("G", CultureInfo.InvariantCulture)" target="_blank">Ver Mapa</a>
                                }
                                else
                                {
                                    <text>N/D</text>
                                }
                            </td>
                            <td>
                                @if (item.LatitudeSaida.HasValue && item.LatitudeSaida != 0)
                                {
                                    <a href="https://www.google.com/maps?q=@item.LatitudeSaida!.Value.ToString("G", CultureInfo.InvariantCulture),@item.LongitudeSaida!.Value.ToString("G", CultureInfo.InvariantCulture)" target="_blank">Ver Mapa</a>
                                }
                                else
                                {
                                    <text>N/D</text>
                                }
                            </td>
                            <td class="table-actions-cell">
                                <a asp-action="Edit" asp-route-id="@item.HorarioId" class="btn btn-sm btn-warning">Editar</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@section Scripts {
    <script type="text/javascript">

        // ================== JAVASCRIPT MODIFICADO ==================
        function downloadHorariosExcelComFiltros() {
            // 1. Ler os 3 campos de filtro
            const filtroNomeInput = document.getElementById('inputFiltroNomeAdmin');
            const filtroDataInicioInput = document.getElementById('inputFiltroDataInicio'); // Novo
            const filtroDataFimInput = document.getElementById('inputFiltroDataFim');     // Novo

            const filtroNome = filtroNomeInput ? filtroNomeInput.value : '';
            const filtroDataInicio = filtroDataInicioInput ? filtroDataInicioInput.value : ''; // Novo
            const filtroDataFim = filtroDataFimInput ? filtroDataFimInput.value : '';         // Novo

            let url = '@Url.Action("DownloadHorariosExcel", "Admin")';
            const params = new URLSearchParams();

            // 2. Adicionar os 3 parâmetros à URL
            if (filtroNome) params.append('filtroNome', filtroNome);
            if (filtroDataInicio) params.append('filtroDataInicio', filtroDataInicio); // Novo
            if (filtroDataFim) params.append('filtroDataFim', filtroDataFim);         // Novo

            if (params.toString()) url += '?' + params.toString();
            window.location.href = url;
        }
        // ================== FIM DA MODIFICAÇÃO ==================

         document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.utc-time').forEach(cell => {
                const utcTimeString = cell.getAttribute('data-utc-time');
                if (utcTimeString && !utcTimeString.startsWith('0001-01-01')) {
                    const date = new Date(utcTimeString);
                    cell.textContent = date.toLocaleTimeString('pt-PT', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }
            });
        });
    </script>
}